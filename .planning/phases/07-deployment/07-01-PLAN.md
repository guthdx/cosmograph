---
phase: 07-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/vite.config.ts
  - src/cosmograph/api/main.py
  - ecosystem.config.js
  - deploy.sh
autonomous: true

must_haves:
  truths:
    - "Vite builds with relative asset paths for static serving"
    - "CORS allows production domain https://cosmograph.iyeska.net"
    - "PM2 ecosystem file configures uvicorn on port 8003"
    - "Deploy script automates git pull, pip install, npm build, pm2 restart"
  artifacts:
    - path: "frontend/vite.config.ts"
      provides: "Relative base path for production builds"
      contains: "base: './',"
    - path: "src/cosmograph/api/main.py"
      provides: "CORS configuration with production origin"
      contains: "https://cosmograph.iyeska.net"
    - path: "ecosystem.config.js"
      provides: "PM2 process configuration"
      contains: "port 8003"
    - path: "deploy.sh"
      provides: "Deployment automation script"
      contains: "pm2 restart cosmograph"
  key_links:
    - from: "ecosystem.config.js"
      to: "cosmograph.api.main:app"
      via: "uvicorn module invocation"
      pattern: "-m uvicorn cosmograph.api.main:app"
---

<objective>
Create production deployment configuration files

Purpose: Prepare the codebase for deployment to Iyeska HQ server with PM2 process management
Output: ecosystem.config.js, deploy.sh, updated vite.config.ts, updated CORS in main.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/07-deployment/07-RESEARCH.md

# Current files to modify
@src/cosmograph/api/main.py
@frontend/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Vite and CORS configuration for production</name>
  <files>frontend/vite.config.ts, src/cosmograph/api/main.py</files>
  <action>
Update frontend/vite.config.ts:
- Add `base: './'` to use relative asset paths (critical for static serving)
- Add `build.outDir: 'dist'` and `build.assetsDir: 'assets'` (explicit)

Update src/cosmograph/api/main.py CORS configuration:
- Add `"https://cosmograph.iyeska.net"` to allow_origins list
- Keep existing localhost origins for development

Reference research pitfall 4: Vite base path must be './' or assets return 404 in production.
Reference research pitfall 2: CORS must include production domain or frontend can't reach API.
  </action>
  <verify>
`grep "base:" frontend/vite.config.ts` shows `base: './'`
`grep "cosmograph.iyeska.net" src/cosmograph/api/main.py` returns match
  </verify>
  <done>
Vite configured for relative paths, CORS includes production origin
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PM2 ecosystem.config.js</name>
  <files>ecosystem.config.js</files>
  <action>
Create ecosystem.config.js in project root following wowasi_ya pattern:

```javascript
module.exports = {
  apps: [{
    name: 'cosmograph',
    script: '.venv/bin/python',
    args: '-m uvicorn cosmograph.api.main:app --host 0.0.0.0 --port 8003',
    cwd: '/home/guthdx/projects/cosmograph',
    env: {
      ENVIRONMENT: 'production',
      // ANTHROPIC_API_KEY set in .env or shell
    },
    watch: false,
    instances: 1,
    autorestart: true,
    max_memory_restart: '1G'
  }]
}
```

Key settings:
- Port 8003 (next available per PORT_REGISTRY.md)
- Uses .venv Python to ensure correct virtual environment
- autorestart: true for resilience
- max_memory_restart: 1G to prevent runaway memory
  </action>
  <verify>
`node -e "console.log(require('./ecosystem.config.js').apps[0].name)"` outputs "cosmograph"
`grep "8003" ecosystem.config.js` returns match
  </verify>
  <done>
PM2 ecosystem file exists and is valid JavaScript
  </done>
</task>

<task type="auto">
  <name>Task 3: Create deploy.sh automation script</name>
  <files>deploy.sh</files>
  <action>
Create deploy.sh in project root following wowasi_ya pattern:

```bash
#!/bin/bash
# Cosmograph deployment script for Iyeska HQ (192.168.11.20)
set -e

cd /home/guthdx/projects/cosmograph

echo "=== Pulling latest code ==="
git pull origin main

echo "=== Updating Python dependencies ==="
source .venv/bin/activate
pip install -e ".[all]"

echo "=== Building frontend ==="
cd frontend
npm ci
npm run build
cd ..

echo "=== Restarting PM2 process ==="
pm2 restart cosmograph --update-env

echo "=== Deployment complete ==="
echo "Check status: pm2 status cosmograph"
echo "Check logs: pm2 logs cosmograph"
echo "Health check: curl http://localhost:8003/health"
```

Make executable with chmod +x.

Key features:
- set -e to fail fast on any error
- Uses pip install -e ".[all]" to get all optional dependencies
- npm ci for clean install (reproducible)
- --update-env to pick up any new environment variables
  </action>
  <verify>
`test -x deploy.sh && echo "executable"` outputs "executable"
`grep "pm2 restart" deploy.sh` returns match
  </verify>
  <done>
Deploy script exists and is executable
  </done>
</task>

</tasks>

<verification>
- [ ] `grep "base:" frontend/vite.config.ts` shows relative path
- [ ] `grep "cosmograph.iyeska.net" src/cosmograph/api/main.py` returns match
- [ ] `node -e "console.log(require('./ecosystem.config.js'))"` parses successfully
- [ ] `test -x deploy.sh` returns success
- [ ] `ruff check src/cosmograph/api/main.py` passes
- [ ] All existing tests still pass: `pytest`
</verification>

<success_criteria>
- Vite builds produce relative asset paths (`base: './'`)
- CORS allows https://cosmograph.iyeska.net
- PM2 ecosystem file targets port 8003 with uvicorn
- Deploy script automates full deployment workflow
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-01-SUMMARY.md`
</output>
