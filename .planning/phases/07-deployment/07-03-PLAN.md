---
phase: 07-deployment
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - .planning/milestones/v0.2.0/ROADMAP.md
  - CLAUDE.md
autonomous: false

must_haves:
  truths:
    - "Cosmograph accessible at https://cosmograph.iyeska.net"
    - "PM2 shows healthy process on Ubuntu server"
    - "Health endpoint returns healthy status"
    - "Frontend loads and can process documents"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Updated deployment documentation"
      contains: "cosmograph.iyeska.net"
    - path: ".planning/milestones/v0.2.0/ROADMAP.md"
      provides: "Phase 7 marked complete"
      contains: "Phase 7: Deployment"
  key_links:
    - from: "https://cosmograph.iyeska.net"
      to: "192.168.11.20:8003"
      via: "Cloudflare Tunnel"
      pattern: "cosmograph.iyeska.net.*localhost:8003"
---

<objective>
Deploy to Iyeska HQ server and validate production setup

Purpose: Make Cosmograph accessible to the Iyeska team at https://cosmograph.iyeska.net
Output: Running production service, updated documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/07-deployment/07-RESEARCH.md
@.planning/phases/07-deployment/07-01-SUMMARY.md
@.planning/phases/07-deployment/07-02-SUMMARY.md

# Deployment config files created in prior plans
@ecosystem.config.js
@deploy.sh
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Deploy to Iyeska HQ Ubuntu server</name>
  <action>
This task requires SSH access to 192.168.11.20 which Claude cannot do directly.

User actions required on Ubuntu server (192.168.11.20):

1. **Clone or pull repository:**
   ```bash
   cd /home/guthdx/projects
   git clone https://github.com/iyeska/cosmograph.git  # If new
   # OR
   cd cosmograph && git pull origin main  # If exists
   ```

2. **Set up Python environment:**
   ```bash
   cd /home/guthdx/projects/cosmograph
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -e ".[all]"
   ```

3. **Build frontend:**
   ```bash
   cd frontend
   npm ci
   npm run build
   cd ..
   ```

4. **Set environment variables (if using LLM):**
   ```bash
   # Either add to .env file:
   echo "ANTHROPIC_API_KEY=your-key-here" > .env

   # Or set in shell profile for PM2 to inherit
   ```

5. **Start PM2:**
   ```bash
   pm2 start ecosystem.config.js
   pm2 save  # Persist for reboot
   ```

6. **Add Cloudflare Tunnel entry:**
   Edit `~/.cloudflared/config.yml` and add:
   ```yaml
   - hostname: cosmograph.iyeska.net
     service: http://localhost:8003
   ```
   (Add before the catch-all `- service: http_status:404` line)

7. **Restart Cloudflare Tunnel:**
   ```bash
   sudo systemctl restart cloudflared
   ```

8. **Verify locally on server:**
   ```bash
   curl http://localhost:8003/health
   # Should return: {"status": "healthy", "version": "0.2.0"}
   ```
  </action>
  <how-to-verify>
After completing server setup:
1. Run `pm2 status` on server - should show "cosmograph" with status "online"
2. Run `curl http://localhost:8003/health` on server - should return healthy
3. Try https://cosmograph.iyeska.net/health from any browser - should return healthy
  </how-to-verify>
  <resume-signal>Type "deployed" when server is running and accessible at cosmograph.iyeska.net, or describe any issues encountered</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end production validation</name>
  <what-built>
Complete Cosmograph v0.2.0 deployment:
- FastAPI backend serving API and React frontend
- PM2 process management
- Cloudflare Tunnel for HTTPS access
- All extraction methods available (pattern, pdf, llm)
  </what-built>
  <how-to-verify>
Full validation checklist:

1. **Frontend loads:**
   - Visit https://cosmograph.iyeska.net
   - Should see Cosmograph UI with upload area

2. **Pattern extraction works:**
   - Upload a .txt file (any document)
   - Select "Generic" extractor
   - Click Extract
   - Should see progress, then graph preview

3. **Download works:**
   - After extraction completes, click "Download HTML"
   - Open downloaded file - should show D3.js visualization

4. **PDF extraction works:**
   - Upload a .pdf file
   - Select "PDF" extractor
   - Verify extraction completes

5. **(Optional) LLM extraction:**
   - Only if ANTHROPIC_API_KEY is configured
   - Upload document, select "LLM"
   - Confirm in dialog
   - Verify extraction completes

6. **CLI still works on server:**
   ```bash
   source .venv/bin/activate
   cosmograph generate --help
   ```
  </how-to-verify>
  <resume-signal>Type "validated" if all checks pass, or describe which checks failed</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Update documentation with deployment info</name>
  <files>CLAUDE.md, .planning/milestones/v0.2.0/ROADMAP.md</files>
  <action>
Update CLAUDE.md deployment section:

1. Update the "Deployment" row in the table to show:
   - Production: cosmograph.iyeska.net (via Cloudflare Tunnel)
   - Port: 8003

2. Add/update deployment commands section:
   ```markdown
   ## Production Deployment

   **URL:** https://cosmograph.iyeska.net
   **Server:** 192.168.11.20 (Iyeska HQ Ubuntu)
   **Port:** 8003
   **Process Manager:** PM2

   ### Deploy updates
   ```bash
   ssh iyeska-hq
   cd /home/guthdx/projects/cosmograph
   ./deploy.sh
   ```

   ### Check status
   ```bash
   pm2 status cosmograph
   pm2 logs cosmograph
   ```
   ```

Update ROADMAP.md:
- Mark Phase 7 tasks as complete with [x]
- Add completion date
- Mark success criteria as complete
  </action>
  <verify>
`grep "cosmograph.iyeska.net" CLAUDE.md` returns match
`grep -A2 "Phase 7" .planning/milestones/v0.2.0/ROADMAP.md | grep "Complete"` returns match
  </verify>
  <done>
Documentation updated with deployment information, Phase 7 marked complete
  </done>
</task>

</tasks>

<verification>
- [ ] https://cosmograph.iyeska.net/health returns {"status": "healthy"}
- [ ] Frontend loads at https://cosmograph.iyeska.net
- [ ] Pattern extraction works end-to-end
- [ ] PDF extraction works end-to-end
- [ ] HTML download produces working visualization
- [ ] CLI works on production server
- [ ] CLAUDE.md documents production deployment
- [ ] ROADMAP.md shows Phase 7 complete
</verification>

<success_criteria>
- Cosmograph accessible at https://cosmograph.iyeska.net
- PM2 shows healthy "cosmograph" process
- Real document can be processed through web UI
- Downloads produce working visualizations
- Documentation updated
- v0.2.0 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-03-SUMMARY.md`
</output>
