---
phase: 07-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cosmograph/api/main.py
  - src/cosmograph/api/static.py
autonomous: true

must_haves:
  truths:
    - "FastAPI serves frontend index.html at root URL"
    - "Static assets served from /assets path"
    - "SPA catch-all routes non-API paths to index.html"
    - "API routes take precedence over catch-all"
  artifacts:
    - path: "src/cosmograph/api/static.py"
      provides: "Static file serving configuration"
      exports: ["setup_static_files"]
    - path: "src/cosmograph/api/main.py"
      provides: "FastAPI app with static file serving"
      contains: "setup_static_files"
  key_links:
    - from: "src/cosmograph/api/main.py"
      to: "frontend/dist/index.html"
      via: "FileResponse in catch-all route"
      pattern: "FileResponse.*index.html"
---

<objective>
Configure FastAPI to serve the React frontend in production

Purpose: Enable single-process deployment where FastAPI serves both API and static frontend files
Output: Static file serving module integrated into FastAPI app
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/07-deployment/07-RESEARCH.md

# Current API structure
@src/cosmograph/api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static file serving module</name>
  <files>src/cosmograph/api/static.py</files>
  <action>
Create src/cosmograph/api/static.py with setup_static_files function:

```python
"""Static file serving for production deployment."""

import os
from pathlib import Path

from fastapi import FastAPI
from fastapi.responses import FileResponse
from fastapi.staticfiles import StaticFiles


def setup_static_files(app: FastAPI) -> None:
    """Configure static file serving for frontend.

    Only activates if frontend/dist exists (production build present).
    API routes are registered first, so they take precedence.
    """
    # Calculate path relative to this module
    module_dir = Path(__file__).parent
    frontend_dist = module_dir.parent.parent.parent / "frontend" / "dist"

    if not frontend_dist.exists():
        return  # No frontend build, skip static serving

    frontend_dist = frontend_dist.resolve()
    assets_dir = frontend_dist / "assets"
    index_html = frontend_dist / "index.html"

    # Mount assets directory for JS/CSS files
    if assets_dir.exists():
        app.mount(
            "/assets",
            StaticFiles(directory=str(assets_dir)),
            name="static_assets"
        )

    @app.get("/", include_in_schema=False)
    async def serve_root():
        """Serve frontend index.html at root."""
        return FileResponse(str(index_html))

    @app.get("/{path:path}", include_in_schema=False)
    async def serve_spa(path: str):
        """Catch-all for SPA routing - serves index.html for non-file paths."""
        # Check if it's a real file in dist
        file_path = frontend_dist / path
        if file_path.exists() and file_path.is_file():
            return FileResponse(str(file_path))
        # Otherwise serve index.html for SPA routing
        return FileResponse(str(index_html))
```

Key design decisions:
- Only activates if frontend/dist exists (dev mode still works)
- API routes registered BEFORE static files, so /api/* takes precedence
- Catch-all serves index.html for client-side routing support
- Path resolved relative to module for deployment flexibility
  </action>
  <verify>
`python -c "from cosmograph.api.static import setup_static_files; print('OK')"` outputs "OK"
`ruff check src/cosmograph/api/static.py` passes
  </verify>
  <done>
Static file module exists and imports successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate static serving into FastAPI app</name>
  <files>src/cosmograph/api/main.py</files>
  <action>
Update src/cosmograph/api/main.py to use static file serving:

1. Import setup_static_files from .static
2. Remove the current root route that redirects to /docs
3. Call setup_static_files(app) AFTER all router includes

The order matters:
- Routers first (health, extract, graph) - these get /api/* and /health
- Static files last (catch-all route)

This ensures /api/extract works, /health works, and everything else goes to frontend.

Note: Keep /docs available (FastAPI default at /docs path still works because it's registered before catch-all).
  </action>
  <verify>
`grep "setup_static_files" src/cosmograph/api/main.py` returns match
`ruff check src/cosmograph/api/main.py` passes
`python -c "from cosmograph.api.main import app; print('OK')"` outputs "OK"
  </verify>
  <done>
FastAPI app configured to serve static files in production
  </done>
</task>

<task type="auto">
  <name>Task 3: Build frontend and verify serving</name>
  <files>None (verification only)</files>
  <action>
Build the frontend and verify static serving works:

1. Build frontend:
   cd frontend && npm run build && cd ..

2. Start uvicorn:
   source .venv/bin/activate
   uvicorn cosmograph.api.main:app --host 0.0.0.0 --port 8000 &

3. Verify endpoints:
   - curl http://localhost:8000/health (should return JSON)
   - curl http://localhost:8000/api/extract (should return method not allowed - confirms API works)
   - curl http://localhost:8000/ (should return HTML with React app)
   - curl http://localhost:8000/assets/index-*.js (should return JavaScript)

4. Stop uvicorn after verification

If frontend build doesn't exist, create it first.
  </action>
  <verify>
`curl -s http://localhost:8000/health | grep -q "healthy" && echo "API OK"`
`curl -s http://localhost:8000/ | grep -q "html" && echo "Frontend OK"`
  </verify>
  <done>
FastAPI serves both API and frontend from single process
  </done>
</task>

</tasks>

<verification>
- [ ] `python -c "from cosmograph.api.static import setup_static_files"` imports successfully
- [ ] `python -c "from cosmograph.api.main import app"` imports successfully
- [ ] `ruff check src/cosmograph/api/` passes
- [ ] `mypy src/cosmograph/api/` passes (or only existing issues)
- [ ] `pytest tests/test_api.py` passes (API tests still work)
- [ ] Manual verification: uvicorn serves frontend at /
</verification>

<success_criteria>
- Static file module created and integrated
- API endpoints continue working (/health, /api/*)
- Root URL serves React frontend (when frontend/dist exists)
- SPA routing works (any non-file path returns index.html)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-deployment/07-02-SUMMARY.md`
</output>
