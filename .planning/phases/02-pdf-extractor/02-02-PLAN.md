---
phase: 02-pdf-extractor
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/cosmograph/cli.py
  - tests/test_extractors.py
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "User can specify -e pdf to use PdfExtractor from CLI"
    - "PDF extractor tests verify text extraction from valid PDFs"
    - "PDF extractor tests verify rejection of encrypted PDFs"
    - "PDF extractor tests verify detection of scanned PDFs"
    - "Multi-page PDFs process as single document"
  artifacts:
    - path: "src/cosmograph/cli.py"
      provides: "CLI with pdf extractor option"
      contains: "PdfExtractor"
    - path: "tests/test_extractors.py"
      provides: "Test class TestPdfExtractor"
      contains: "class TestPdfExtractor"
    - path: "tests/conftest.py"
      provides: "PDF fixture generators"
      contains: "create_test_pdf"
  key_links:
    - from: "src/cosmograph/cli.py"
      to: "src/cosmograph/extractors/pdf.py"
      via: "import and instantiation"
      pattern: "from .extractors import.*PdfExtractor"
    - from: "tests/test_extractors.py"
      to: "src/cosmograph/extractors/pdf.py"
      via: "import for testing"
      pattern: "from cosmograph.extractors import.*PdfExtractor"
---

<objective>
Integrate PdfExtractor into CLI and add comprehensive tests.

Purpose: Complete the PDF support feature by enabling CLI usage and ensuring quality through tests.

Output: Working CLI option `-e pdf` and test suite covering all PDF extraction scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-pdf-extractor/02-RESEARCH.md
@.planning/phases/02-pdf-extractor/02-01-SUMMARY.md
@src/cosmograph/cli.py
@tests/test_extractors.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF option to CLI</name>
  <files>src/cosmograph/cli.py</files>
  <action>
Update `src/cosmograph/cli.py`:

1. Add PdfExtractor to imports:
   ```python
   from .extractors import GenericExtractor, LegalDocumentExtractor, PdfExtractor, TextExtractor
   ```

2. Update `--extractor` option help text to include pdf:
   ```python
   extractor: str = typer.Option(
       "auto", "-e", "--extractor", help="Extractor type: auto, legal, text, generic, pdf"
   )
   ```

3. Update `_get_extractor()` function to handle "pdf":
   ```python
   elif extractor_type == "pdf":
       return PdfExtractor(graph)
   ```

4. Update auto-detection logic in `_get_extractor()` to use PdfExtractor for .pdf files:
   - This requires passing the input file(s) to the function, OR
   - Keep auto as LegalDocumentExtractor (PDF users must specify -e pdf explicitly)
   - DECISION: Keep simple - users specify `-e pdf` explicitly. Auto stays as-is.
  </action>
  <verify>
```bash
# Verify help shows pdf option
cosmograph generate --help | grep -i pdf

# Verify import works
python -c "from cosmograph.cli import _get_extractor; from cosmograph.models import Graph; e = _get_extractor('pdf', Graph()); print(f'Got: {type(e).__name__}')"
```
  </verify>
  <done>CLI accepts `-e pdf` option and instantiates PdfExtractor</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF test fixtures</name>
  <files>tests/conftest.py</files>
  <action>
Create or update `tests/conftest.py` with PDF fixture generators using PyMuPDF:

1. Add fixture `create_test_pdf` that creates a simple PDF with text:
   ```python
   @pytest.fixture
   def create_test_pdf(tmp_path):
       """Factory fixture to create test PDFs with PyMuPDF."""
       def _create(filename: str, content: str, pages: int = 1) -> Path:
           import pymupdf
           filepath = tmp_path / filename
           doc = pymupdf.open()
           for i in range(pages):
               page = doc.new_page()
               # Insert text at top of page
               page.insert_text((72, 72), content if i == 0 else f"Page {i+1}\n{content}", fontsize=12)
           doc.save(str(filepath))
           doc.close()
           return filepath
       return _create
   ```

2. Add fixture `create_encrypted_pdf` that creates a password-protected PDF:
   ```python
   @pytest.fixture
   def create_encrypted_pdf(tmp_path):
       """Create an encrypted PDF for testing."""
       def _create(filename: str = "encrypted.pdf") -> Path:
           import pymupdf
           filepath = tmp_path / filename
           doc = pymupdf.open()
           page = doc.new_page()
           page.insert_text((72, 72), "Secret content", fontsize=12)
           # Encrypt with user password
           doc.save(str(filepath), encryption=pymupdf.PDF_ENCRYPT_AES_256, user_pw="secret")
           doc.close()
           return filepath
       return _create
   ```

3. Add fixture `create_image_only_pdf` that creates a PDF with only an image (simulates scanned):
   ```python
   @pytest.fixture
   def create_image_only_pdf(tmp_path):
       """Create a PDF with only an image (simulates scanned document)."""
       def _create(filename: str = "scanned.pdf") -> Path:
           import pymupdf
           filepath = tmp_path / filename
           doc = pymupdf.open()
           page = doc.new_page()
           # Create a simple colored rectangle as an image covering the page
           rect = page.rect
           page.draw_rect(rect, color=(0.9, 0.9, 0.9), fill=(0.9, 0.9, 0.9))
           doc.save(str(filepath))
           doc.close()
           return filepath
       return _create
   ```

Note: These fixtures use PyMuPDF directly (already in [pdf] extras) rather than adding reportlab as a new dependency.
  </action>
  <verify>
```bash
# Verify conftest.py has fixtures
grep -c "create_test_pdf\|create_encrypted_pdf\|create_image_only_pdf" tests/conftest.py
```
  </verify>
  <done>PDF fixture generators exist in conftest.py</done>
</task>

<task type="auto">
  <name>Task 3: Add PdfExtractor tests</name>
  <files>tests/test_extractors.py</files>
  <action>
Add `TestPdfExtractor` class to `tests/test_extractors.py`:

1. Add PdfExtractor to imports:
   ```python
   from cosmograph.extractors import LegalDocumentExtractor, TextExtractor, GenericExtractor, PdfExtractor
   ```

2. Add test class:
   ```python
   class TestPdfExtractor:
       """Tests for PdfExtractor."""

       @pytest.fixture
       def extractor(self):
           return PdfExtractor()

       def test_supports_pdf_files(self, extractor):
           assert extractor.supports(Path("test.pdf"))
           assert extractor.supports(Path("TEST.PDF"))  # Case insensitive
           assert not extractor.supports(Path("test.txt"))
           assert not extractor.supports(Path("test.md"))

       def test_extracts_text_from_pdf(self, extractor, create_test_pdf):
           pdf_file = create_test_pdf("legal.pdf", "TITLE I: GENERAL PROVISIONS\nSome content here.")
           graph = extractor.extract(pdf_file)
           # Should have document node + extracted entities
           assert len(graph.nodes) >= 1
           # Should extract title from legal document patterns
           assert any("Title" in n.label for n in graph.nodes.values())

       def test_extracts_from_multipage_pdf(self, extractor, create_test_pdf):
           pdf_file = create_test_pdf(
               "multipage.pdf",
               "ARTICLE I - RIGHTS\nFirst page content.",
               pages=3
           )
           graph = extractor.extract(pdf_file)
           # Should process all pages as single document
           assert len(graph.nodes) >= 2
           assert any("Article I" in n.label for n in graph.nodes.values())

       def test_rejects_encrypted_pdf(self, extractor, create_encrypted_pdf):
           pdf_file = create_encrypted_pdf()
           with pytest.raises(ValueError, match="password-protected"):
               extractor.extract(pdf_file)

       def test_detects_scanned_pdf(self, extractor, create_image_only_pdf):
           pdf_file = create_image_only_pdf()
           with pytest.raises(ValueError, match="scanned"):
               extractor.extract(pdf_file)

       def test_creates_document_node(self, extractor, create_test_pdf):
           pdf_file = create_test_pdf("doc.pdf", "Some content")
           graph = extractor.extract(pdf_file)
           doc_nodes = [n for n in graph.nodes.values() if n.category in ("document", "code", "constitution", "ordinance")]
           assert len(doc_nodes) >= 1
   ```

Run tests to verify:
```bash
pytest tests/test_extractors.py::TestPdfExtractor -v
```
  </action>
  <verify>
```bash
pytest tests/test_extractors.py::TestPdfExtractor -v
```
  </verify>
  <done>All TestPdfExtractor tests pass</done>
</task>

</tasks>

<verification>
```bash
# Run full test suite to ensure no regressions
pytest tests/ -v

# Verify PDF-specific tests
pytest tests/test_extractors.py::TestPdfExtractor -v

# Test CLI end-to-end with a generated PDF (if possible)
# This may require creating a temp PDF first
```
</verification>

<success_criteria>
- CLI accepts `-e pdf` option
- CLI help text includes "pdf" in extractor options
- TestPdfExtractor class exists with at least 5 test methods
- All PDF tests pass
- Full test suite passes (no regressions)
- Coverage maintained or improved
</success_criteria>

<output>
After completion, create `.planning/phases/02-pdf-extractor/02-02-SUMMARY.md`
</output>
