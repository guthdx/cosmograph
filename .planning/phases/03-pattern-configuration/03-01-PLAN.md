---
phase: 03-pattern-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cosmograph/config/__init__.py
  - src/cosmograph/config/patterns.py
  - src/cosmograph/config/default_patterns.yaml
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "PatternConfig model validates YAML structure with clear error messages"
    - "Invalid regex patterns fail validation at load time"
    - "Patterns must have exactly one capture group"
    - "Default patterns file loads successfully"
  artifacts:
    - path: "src/cosmograph/config/__init__.py"
      provides: "Module exports"
      exports: ["PatternConfig", "EntityPattern", "load_patterns"]
    - path: "src/cosmograph/config/patterns.py"
      provides: "Pydantic models and loader function"
      min_lines: 60
    - path: "src/cosmograph/config/default_patterns.yaml"
      provides: "Bundled default extraction patterns"
      contains: "entity_patterns"
  key_links:
    - from: "src/cosmograph/config/patterns.py"
      to: "pydantic"
      via: "BaseModel inheritance"
      pattern: "class.*BaseModel"
    - from: "src/cosmograph/config/patterns.py"
      to: "yaml"
      via: "safe_load in load_patterns"
      pattern: "yaml\\.safe_load"
---

<objective>
Create the PatternConfig Pydantic models and default patterns YAML file.

Purpose: Enable YAML-based pattern configuration for entity extraction (FR-3). This plan establishes the data models and bundled defaults that GenericExtractor and CLI will consume.

Output:
- src/cosmograph/config/ module with Pydantic models
- Bundled default_patterns.yaml with generic extraction patterns
- PyYAML added to core dependencies
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/03-pattern-configuration/03-RESEARCH.md

@src/cosmograph/extractors/generic.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PatternConfig Pydantic models</name>
  <files>
    src/cosmograph/config/__init__.py
    src/cosmograph/config/patterns.py
  </files>
  <action>
Create the config module with Pydantic models for pattern configuration:

1. Create `src/cosmograph/config/` directory

2. Create `src/cosmograph/config/patterns.py` with:
   - `EntityPattern` model: name (str), pattern (str), category (str), description (str = ""), min_length (int = 2)
   - `RelationshipTrigger` model: name (str), source_categories (list[str]), target_categories (list[str]), proximity (int = 0), trigger_pattern (str | None = None)
   - `PatternConfig` model: version (str = "1.0"), name (str = "default"), description (str = ""), min_occurrences (int = 2), entity_patterns (list[EntityPattern]), relationship_triggers (list[RelationshipTrigger] = [])
   - `load_patterns(filepath: Path) -> PatternConfig` function using yaml.safe_load + model_validate
   - `load_default_patterns() -> PatternConfig` function using importlib.resources

3. Add field_validator on EntityPattern.pattern that:
   - Validates regex compiles with re.compile()
   - Validates exactly one capture group (compiled.groups == 1)
   - Raises ValueError with clear message on failure

4. Create `src/cosmograph/config/__init__.py` exporting:
   - PatternConfig, EntityPattern, RelationshipTrigger
   - load_patterns, load_default_patterns

Use Pydantic 2.x syntax (model_validate, field_validator decorator).
  </action>
  <verify>
python -c "from cosmograph.config import PatternConfig, load_patterns; print('Import OK')"
python -c "from cosmograph.config.patterns import EntityPattern; e = EntityPattern(name='test', pattern=r'([a-z]+)', category='test'); print(f'Valid pattern: {e.name}')"
python -c "from cosmograph.config.patterns import EntityPattern; EntityPattern(name='bad', pattern='[', category='test')" 2>&1 | grep -q "Invalid regex"
  </verify>
  <done>
PatternConfig models import cleanly, valid patterns pass validation, invalid regex rejected with clear error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create default patterns YAML and add PyYAML dependency</name>
  <files>
    src/cosmograph/config/default_patterns.yaml
    pyproject.toml
  </files>
  <action>
1. Add PyYAML to core dependencies in pyproject.toml:
   - Add "pyyaml>=6.0" to dependencies list
   - Note: Pydantic is not needed as direct dependency (already available via optional deps or can add if needed)

2. Create `src/cosmograph/config/default_patterns.yaml` with:
```yaml
version: "1.0"
name: "default"
description: "Generic document extraction patterns"
min_occurrences: 2

entity_patterns:
  - name: proper_noun
    pattern: '\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\b'
    category: proper_noun
    description: "Multi-word capitalized phrases (names, places)"
    min_length: 3

  - name: acronym
    pattern: '\b([A-Z]{2,6})\b'
    category: acronym
    description: "Uppercase acronyms 2-6 characters"
    min_length: 2

  - name: quoted_term
    pattern: '"([^"]+)"'
    category: quoted_term
    description: "Text in double quotes"
    min_length: 2

  - name: section_ref
    pattern: '(?:Section|ยง)\s*(\d+(?:\.\d+)*)'
    category: section_ref
    description: "Section number references"
    min_length: 1

relationship_triggers:
  - name: mentions
    source_categories: [document]
    target_categories: [proper_noun, acronym, quoted_term, section_ref]
    proximity: 0
```

Note: Use single quotes for YAML strings containing regex (avoids backslash issues).

3. Update load_default_patterns() in patterns.py to load this file using importlib.resources:
```python
from importlib.resources import files

def load_default_patterns() -> PatternConfig:
    yaml_content = files("cosmograph.config").joinpath("default_patterns.yaml").read_text()
    raw_data = yaml.safe_load(yaml_content)
    return PatternConfig.model_validate(raw_data)
```
  </action>
  <verify>
pip install -e ".[dev]"
python -c "from cosmograph.config import load_default_patterns; c = load_default_patterns(); print(f'Loaded {len(c.entity_patterns)} patterns')"
  </verify>
  <done>
PyYAML installed, default patterns load successfully, returns PatternConfig with 4 entity patterns.
  </done>
</task>

</tasks>

<verification>
1. Run type checker: `mypy src/cosmograph/config/`
2. Test pattern validation:
   - Valid regex with one capture group: passes
   - Invalid regex syntax: raises ValueError
   - Regex with zero capture groups: raises ValueError
   - Regex with multiple capture groups: raises ValueError
3. Test load_default_patterns returns valid PatternConfig
4. Verify YAML patterns match GenericExtractor.DEFAULT_PATTERNS behavior
</verification>

<success_criteria>
- config module exists with PatternConfig, EntityPattern, load_patterns exports
- load_default_patterns() returns PatternConfig with 4 entity patterns
- Invalid patterns rejected at load time with clear error messages
- PyYAML added to core dependencies
- All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-configuration/03-01-SUMMARY.md`
</output>
