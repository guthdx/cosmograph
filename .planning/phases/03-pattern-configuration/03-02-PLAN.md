---
phase: 03-pattern-configuration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/cosmograph/extractors/generic.py
  - src/cosmograph/cli.py
autonomous: true

must_haves:
  truths:
    - "GenericExtractor accepts PatternConfig via constructor"
    - "CLI --patterns option loads custom pattern file"
    - "Default patterns work when no --patterns specified"
    - "Invalid pattern file shows helpful error message"
  artifacts:
    - path: "src/cosmograph/extractors/generic.py"
      provides: "PatternConfig integration"
      contains: "config: Optional[PatternConfig]"
    - path: "src/cosmograph/cli.py"
      provides: "CLI --patterns option"
      contains: "--patterns"
  key_links:
    - from: "src/cosmograph/extractors/generic.py"
      to: "src/cosmograph/config/patterns.py"
      via: "import PatternConfig"
      pattern: "from.*config.*import.*PatternConfig"
    - from: "src/cosmograph/cli.py"
      to: "src/cosmograph/config/patterns.py"
      via: "import load_patterns"
      pattern: "from.*config.*import.*load_patterns"
---

<objective>
Integrate PatternConfig into GenericExtractor and add CLI --patterns option.

Purpose: Wire the pattern configuration system into the extraction pipeline, allowing users to specify custom patterns via CLI without code changes (FR-3 acceptance criteria).

Output:
- GenericExtractor accepts PatternConfig in constructor
- CLI has --patterns option that loads YAML file
- Existing behavior unchanged when no patterns specified
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/03-pattern-configuration/03-RESEARCH.md
@.planning/phases/03-pattern-configuration/03-01-SUMMARY.md

@src/cosmograph/extractors/generic.py
@src/cosmograph/cli.py
@src/cosmograph/config/patterns.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GenericExtractor to accept PatternConfig</name>
  <files>src/cosmograph/extractors/generic.py</files>
  <action>
Modify GenericExtractor to support PatternConfig alongside existing dict patterns:

1. Add import: `from ..config import PatternConfig`

2. Update __init__ signature:
```python
def __init__(
    self,
    graph: Optional[Graph] = None,
    patterns: Optional[dict[str, str]] = None,
    config: Optional[PatternConfig] = None,
    min_occurrences: int = 2,
):
```

3. Add logic to handle config parameter:
```python
if config is not None:
    # Build patterns dict from config
    pattern_strings = {
        ep.name: ep.pattern for ep in config.entity_patterns
    }
    self.min_occurrences = config.min_occurrences
    # Store metadata for future use (category mapping, min_length)
    self._pattern_metadata = {
        ep.name: ep for ep in config.entity_patterns
    }
elif patterns is not None:
    pattern_strings = patterns
    self._pattern_metadata = {}
else:
    pattern_strings = self.DEFAULT_PATTERNS
    self._pattern_metadata = {}
```

4. Update extract() to use pattern metadata for category:
   - When pattern matches, look up category from _pattern_metadata if available
   - Fall back to pattern name as category (current behavior) if no metadata
   - Use ep.min_length from metadata if available, else default 2

Keep existing behavior unchanged when neither config nor patterns provided.
  </action>
  <verify>
python -c "
from cosmograph.extractors import GenericExtractor
from cosmograph.config import load_default_patterns

# Test with config
config = load_default_patterns()
ext = GenericExtractor(config=config)
print(f'Config patterns: {len(ext._compiled_patterns)}')

# Test with dict (existing)
ext2 = GenericExtractor(patterns={'test': r'(\\btest\\b)'})
print(f'Dict patterns: {len(ext2._compiled_patterns)}')

# Test default
ext3 = GenericExtractor()
print(f'Default patterns: {len(ext3._compiled_patterns)}')
"
  </verify>
  <done>
GenericExtractor accepts PatternConfig, existing dict patterns still work, default patterns unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI --patterns option</name>
  <files>src/cosmograph/cli.py</files>
  <action>
Add --patterns option to the generate command:

1. Add imports at top:
```python
from typing import Annotated, Optional
from .config import load_patterns, load_default_patterns, PatternConfig
from pydantic import ValidationError
```

2. Add parameter to generate command:
```python
patterns_file: Annotated[Optional[Path], typer.Option(
    "--patterns",
    exists=True,
    file_okay=True,
    dir_okay=False,
    readable=True,
    help="Path to patterns.yaml configuration file"
)] = None,
```

3. Update _get_extractor to accept optional PatternConfig:
```python
def _get_extractor(extractor_type: str, graph: Graph, config: Optional[PatternConfig] = None):
```

4. In _get_extractor, when extractor_type == "generic":
   - If config provided: `return GenericExtractor(graph, config=config)`
   - Else: `return GenericExtractor(graph)`

5. In generate command, before calling _get_extractor:
```python
pattern_config = None
if patterns_file:
    try:
        pattern_config = load_patterns(patterns_file)
        console.print(f"[dim]Loaded {len(pattern_config.entity_patterns)} patterns from {patterns_file.name}[/dim]")
    except (ValueError, ValidationError) as e:
        console.print(f"[red]Error:[/red] Invalid patterns file: {e}")
        raise typer.Exit(1)
```

6. Pass pattern_config to _get_extractor:
```python
extractor_instance = _get_extractor(extractor, graph, pattern_config)
```

7. Note: --patterns only affects generic extractor. If user specifies --patterns with -e legal, patterns are loaded but not used (legal extractor has its own patterns). Consider warning or documenting this.
  </action>
  <verify>
# Test help shows option
cosmograph generate --help | grep -q "patterns"

# Test with default patterns file (create temp test)
python -c "
import tempfile
import yaml
from pathlib import Path

patterns = {
    'version': '1.0',
    'name': 'test',
    'min_occurrences': 1,
    'entity_patterns': [
        {'name': 'email', 'pattern': r'([a-z]+@[a-z]+\\.com)', 'category': 'email'}
    ],
    'relationship_triggers': []
}

with tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False) as f:
    yaml.dump(patterns, f)
    print(f'Created: {f.name}')
"
  </verify>
  <done>
CLI --patterns option available, loads YAML file, shows helpful error for invalid files, passes config to GenericExtractor.
  </done>
</task>

</tasks>

<verification>
1. Run `cosmograph generate --help` and verify --patterns option documented
2. Test extraction with custom patterns file:
   - Create test.yaml with email pattern
   - Run `cosmograph generate ./test.txt -e generic --patterns test.yaml`
   - Verify emails extracted
3. Test error handling:
   - Invalid YAML syntax: clear error message
   - Invalid regex in patterns: clear error message
   - File not found: clear error message
4. Test backward compatibility:
   - `cosmograph generate ./docs -e generic` works without --patterns
   - `cosmograph generate ./docs -e legal` works (ignores any patterns)
</verification>

<success_criteria>
- GenericExtractor(config=PatternConfig(...)) creates extractor with custom patterns
- CLI --patterns option loads YAML file and passes to extractor
- Invalid pattern files show helpful error messages
- Existing CLI commands work unchanged
- Type hints pass mypy check
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-configuration/03-02-SUMMARY.md`
</output>
