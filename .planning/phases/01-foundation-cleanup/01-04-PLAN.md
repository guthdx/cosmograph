---
phase: 01-foundation-cleanup
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/cosmograph/templates/graph.html.j2
  - src/cosmograph/generators/html.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "HTML template lives in separate .j2 file"
    - "HTMLGenerator loads template via Jinja2 PackageLoader"
    - "Generated HTML output identical to before (visual parity)"
    - "Template file included in package distribution"
  artifacts:
    - path: "src/cosmograph/templates/graph.html.j2"
      provides: "Jinja2 template for D3.js visualization"
      min_lines: 200
    - path: "src/cosmograph/generators/html.py"
      provides: "HTMLGenerator using Jinja2"
      contains: "PackageLoader"
  key_links:
    - from: "src/cosmograph/generators/html.py"
      to: "src/cosmograph/templates/graph.html.j2"
      via: "Jinja2 PackageLoader"
      pattern: "get_template.*graph.html.j2"
---

<objective>
Extract inline HTML from HTMLGenerator into a Jinja2 template file.

Purpose: The 200+ line HTML string in html.py makes it hard to edit and impossible to get IDE support. Separating the template enables proper HTML/CSS/JS editing and cleaner Python code.

Output: src/cosmograph/templates/graph.html.j2 template file, updated html.py using Jinja2 loader
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/01-foundation-cleanup/01-RESEARCH.md

# Files to modify
@src/cosmograph/generators/html.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Jinja2 template from inline HTML</name>
  <files>src/cosmograph/templates/graph.html.j2</files>
  <action>
Create directory src/cosmograph/templates/ and file graph.html.j2.

Extract the HTML from _generate_html() method. Convert from Python f-string to Jinja2:

1. Replace f-string variables with Jinja2 syntax:
   - `{title}` -> `{{ title }}`
   - `{nodes_json}` -> `{{ nodes_json|safe }}`
   - `{edges_json}` -> `{{ edges_json|safe }}`
   - `{colors_json}` -> `{{ colors_json|safe }}`
   - `{stats["nodes"]}` -> `{{ stats.nodes }}`
   - `{stats["edges"]}` -> `{{ stats.edges }}`

2. Handle CSS double-braces (Python escape vs Jinja):
   - In f-string: `{{ margin: 0; }}` (escaped braces)
   - In Jinja2: `{ margin: 0; }` (literal braces, no escaping needed)

3. Wrap JavaScript in `{% raw %}...{% endraw %}` block to preserve:
   - D3.js arrow functions with template literals: `d => \`translate(${d.x})\``
   - Event handlers with object destructuring

4. But KEEP Jinja variables for data injection (these work inside raw blocks):
   - `const nodes = {{ nodes_json|safe }};`
   - `const links = {{ edges_json|safe }};`
   - `const categoryColors = {{ colors_json|safe }};`

IMPORTANT: The |safe filter prevents HTML escaping of JSON data.

Test the template renders without Jinja syntax errors.
  </action>
  <verify>
# Verify template exists and has content
wc -l /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/templates/graph.html.j2

# Verify Jinja2 variables present
grep "{{ title }}" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/templates/graph.html.j2
grep "{{ nodes_json|safe }}" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/templates/graph.html.j2

# Verify raw block for JavaScript
grep -A 2 "{% raw %}" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/templates/graph.html.j2
  </verify>
  <done>Template file exists with 200+ lines, Jinja2 syntax for variables, raw block protecting JavaScript</done>
</task>

<task type="auto">
  <name>Task 2: Update HTMLGenerator to use Jinja2 and configure package data</name>
  <files>src/cosmograph/generators/html.py, pyproject.toml</files>
  <action>
**Update html.py:**

1. Add Jinja2 imports:
```python
from jinja2 import Environment, PackageLoader
```

2. Add Environment setup in __init__:
```python
def __init__(self):
    self.env = Environment(
        loader=PackageLoader("cosmograph", "templates"),
        autoescape=False  # We control escaping with |safe filter
    )
```

3. Replace _generate_html() method:
```python
def _generate_html(
    self, title: str, nodes_json: str, edges_json: str, colors_json: str, stats: dict
) -> str:
    template = self.env.get_template("graph.html.j2")
    return template.render(
        title=title,
        nodes_json=nodes_json,
        edges_json=edges_json,
        colors_json=colors_json,
        stats=stats
    )
```

4. Remove the giant f-string that was previously returned.

**Update pyproject.toml:**

Add template files to package data so they're included in wheel/sdist:
```toml
[tool.hatch.build.targets.wheel]
packages = ["src/cosmograph"]

[tool.hatch.build.targets.wheel.force-include]
"src/cosmograph/templates" = "cosmograph/templates"
```

Or use the simpler approach - just ensure templates/ is inside the package (which it is) and hatch includes it by default.
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate

# Reinstall package to pick up template
pip install -e .

# Test template loading
python -c "from cosmograph.generators.html import HTMLGenerator; g = HTMLGenerator(); print('Template loads OK')"

# Generate output and compare
echo "ARTICLE I - TEST
SECTION 1. Test section." > /tmp/jinja_test.txt
cosmograph generate /tmp/jinja_test.txt -e legal -o /tmp/jinja_output.html

# Verify HTML has expected structure
grep "<title>" /tmp/jinja_output.html
grep "d3.forceSimulation" /tmp/jinja_output.html
grep "const nodes = " /tmp/jinja_output.html

rm /tmp/jinja_test.txt /tmp/jinja_output.html
  </verify>
  <done>HTMLGenerator uses Jinja2 PackageLoader, template loads correctly, generated HTML has all expected elements</done>
</task>

<task type="auto">
  <name>Task 3: Verify visual parity with test</name>
  <files>tests/test_generators.py</files>
  <action>
Create tests/test_generators.py with basic tests for HTMLGenerator:

```python
import pytest
from pathlib import Path
from cosmograph.generators.html import HTMLGenerator
from cosmograph.models import Graph


class TestHTMLGenerator:
    """Tests for HTMLGenerator output."""

    @pytest.fixture
    def generator(self):
        return HTMLGenerator()

    @pytest.fixture
    def sample_graph(self):
        graph = Graph(title="Test Graph")
        graph.add_node("node1", "Node One", "category")
        graph.add_node("node2", "Node Two", "category")
        graph.add_edge("node1", "node2", "relates")
        return graph

    def test_generates_html_file(self, generator, sample_graph, tmp_path):
        output = tmp_path / "output.html"
        result = generator.generate(sample_graph, output)
        assert result.exists()
        assert result.stat().st_size > 0

    def test_html_contains_title(self, generator, sample_graph, tmp_path):
        output = tmp_path / "output.html"
        generator.generate(sample_graph, output)
        html = output.read_text()
        assert "<title>Test Graph</title>" in html

    def test_html_contains_d3(self, generator, sample_graph, tmp_path):
        output = tmp_path / "output.html"
        generator.generate(sample_graph, output)
        html = output.read_text()
        assert "d3.v7.min.js" in html
        assert "d3.forceSimulation" in html

    def test_html_contains_node_data(self, generator, sample_graph, tmp_path):
        output = tmp_path / "output.html"
        generator.generate(sample_graph, output)
        html = output.read_text()
        assert "Node One" in html
        assert "Node Two" in html

    def test_html_self_contained(self, generator, sample_graph, tmp_path):
        """Verify no external fetches except D3 CDN."""
        output = tmp_path / "output.html"
        generator.generate(sample_graph, output)
        html = output.read_text()
        # Only external resource should be D3
        assert html.count("https://") == 1
        assert "d3js.org" in html
```

Run tests to verify template produces correct output.
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate
pytest tests/test_generators.py -v
  </verify>
  <done>All generator tests pass, HTML output verified for structure, D3, title, and self-containment</done>
</task>

</tasks>

<verification>
```bash
cd /Users/guthdx/terminal_projects/cosmograph
source .venv/bin/activate

# Run all tests
pytest tests/ -v

# Type checking
mypy src/cosmograph/generators/html.py

# Linting
ruff check src/cosmograph/generators/

# Full integration test
echo "ARTICLE I - RIGHTS
SECTION 1. Basic rights.
TITLE I: GOVERNANCE
CHAPTER 1: OVERVIEW" > /tmp/full_test.txt
cosmograph generate /tmp/full_test.txt -e legal -o /tmp/full_output.html

# Open in browser to visually verify (optional)
# open /tmp/full_output.html

rm /tmp/full_test.txt /tmp/full_output.html
```
</verification>

<success_criteria>
- src/cosmograph/templates/graph.html.j2 exists with full template
- HTMLGenerator.__init__ creates Jinja2 Environment with PackageLoader
- _generate_html() uses template.render() instead of f-string
- Template loads after pip install -e .
- Generated HTML is visually identical (same structure, same D3 behavior)
- All new tests pass
- mypy and ruff pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cleanup/01-04-SUMMARY.md`
</output>
