---
phase: 01-foundation-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cosmograph/extractors/legal.py
  - src/cosmograph/extractors/text.py
  - src/cosmograph/extractors/generic.py
autonomous: true

must_haves:
  truths:
    - "All regex patterns compiled as class attributes"
    - "No re.finditer() calls with raw string patterns"
    - "Extractors still produce identical output"
  artifacts:
    - path: "src/cosmograph/extractors/legal.py"
      provides: "LegalDocumentExtractor with pre-compiled patterns"
      contains: "_ARTICLE_PATTERN = re.compile"
    - path: "src/cosmograph/extractors/text.py"
      provides: "TextExtractor with pre-compiled patterns"
      contains: "_HEADER_PATTERN = re.compile"
    - path: "src/cosmograph/extractors/generic.py"
      provides: "GenericExtractor with compiled pattern support"
      contains: "re.compile"
  key_links:
    - from: "src/cosmograph/extractors/legal.py"
      to: "re module"
      via: "class attribute compilation"
      pattern: "^class.*:.*_.*_PATTERN = re.compile"
---

<objective>
Pre-compile regex patterns as class attributes in all extractors.

Purpose: Currently patterns are compiled on every method call (Python caches, but cache has limits). Pre-compiling makes the pattern ownership explicit and eliminates any cache miss possibility.

Output: Updated legal.py, text.py, generic.py with class-level compiled patterns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/01-foundation-cleanup/01-RESEARCH.md

# Files to modify
@src/cosmograph/extractors/legal.py
@src/cosmograph/extractors/text.py
@src/cosmograph/extractors/generic.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-compile patterns in LegalDocumentExtractor</name>
  <files>src/cosmograph/extractors/legal.py</files>
  <action>
Add pre-compiled patterns as class attributes (use leading underscore for internal):

```python
class LegalDocumentExtractor(BaseExtractor):
    # Pre-compiled patterns
    _ARTICLE_PATTERN = re.compile(r"ARTICLE\s+([IVX]+)[—\-\s]+([A-Z\s]+)")
    _SECTION_PATTERN = re.compile(r"(?:SECTION|SEC\.?)\s+(\d+)\.")
    _ORDINANCE_SECTION_PATTERN = re.compile(r"Section\s+(\d+)[.:\s]+([A-Za-z\s]+)")
    _TITLE_PATTERN = re.compile(r"TITLE\s+([IVXLC\d]+)[:\s—\-]+([A-Z\s]+)")
    _CHAPTER_PATTERN = re.compile(r"CHAPTER\s+([IVXLC\d]+)[,:\s—\-]+([A-Z\s]+)")
    _OFFENSE_PATTERN = re.compile(
        r"(?:guilty of|commits?) (?:the offense of |an offense of )?([A-Za-z\s]+?)(?:\s+if|\s+when|\s+shall)",
        re.IGNORECASE
    )
    _DEFINITION_PATTERN = re.compile(
        r'"([A-Za-z\s]+)"\s+(?:means|shall mean|is defined as)\s+([^.]+)'
    )
```

Update method bodies to use class attributes:
- `_extract_constitution`: Use `self._ARTICLE_PATTERN.finditer()` and `self._SECTION_PATTERN.finditer()`
- `_extract_ordinance`: Use `self._ORDINANCE_SECTION_PATTERN.finditer()`
- `_extract_code`: Use `self._TITLE_PATTERN.finditer()`, `self._CHAPTER_PATTERN.finditer()`, `self._OFFENSE_PATTERN.finditer()`, `self._DEFINITION_PATTERN.finditer()`

Remove the inline `offense_patterns` list in `_extract_code` - use the class attribute instead.
  </action>
  <verify>
# Verify patterns are class attributes
grep "_PATTERN = re.compile" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/extractors/legal.py

# Verify no raw pattern strings in finditer calls
grep -n "re.finditer" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/extractors/legal.py | grep -v "self\._"
  </verify>
  <done>All 7 patterns pre-compiled as class attributes, all finditer calls use self._*_PATTERN</done>
</task>

<task type="auto">
  <name>Task 2: Pre-compile patterns in TextExtractor and GenericExtractor</name>
  <files>src/cosmograph/extractors/text.py, src/cosmograph/extractors/generic.py</files>
  <action>
**TextExtractor (text.py):**
Replace PATTERNS dict with pre-compiled class attributes:
```python
class TextExtractor(BaseExtractor):
    _HEADER_PATTERN = re.compile(r"^#{1,6}\s+(.+)$", re.MULTILINE)
    _DEFINITION_PATTERN = re.compile(
        r'"([A-Za-z\s]+)"\s+(?:means|shall mean|is defined as)\s+([^.]+)'
    )
    _REFERENCE_PATTERN = re.compile(
        r"(?:see|refer to|pursuant to)\s+([A-Za-z\s\d\-]+)"
    )
```

Update `_extract_headers` to use `self._HEADER_PATTERN.finditer(text)` (no flags needed, already in pattern).
Update `_extract_definitions` to use `self._DEFINITION_PATTERN.finditer(text)`.
Remove the PATTERNS dict.

**GenericExtractor (generic.py):**
Keep DEFAULT_PATTERNS as string dict (it's used for dynamic pattern configuration).
But compile patterns in __init__ for the instance:
```python
def __init__(self, graph=None, patterns=None, min_occurrences=2):
    super().__init__(graph)
    pattern_strings = patterns or self.DEFAULT_PATTERNS
    self.min_occurrences = min_occurrences
    # Compile patterns once at init
    self._compiled_patterns = {
        category: re.compile(pattern)
        for category, pattern in pattern_strings.items()
    }
```

Update extract() to use `self._compiled_patterns[category].finditer(text)`.
  </action>
  <verify>
# TextExtractor patterns
grep "_PATTERN = re.compile" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/extractors/text.py

# GenericExtractor compiled patterns
grep "_compiled_patterns" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/extractors/generic.py

# Verify CLI still works with all extractors
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate
echo "# Test Header
Some content here." > /tmp/test_text.txt
cosmograph generate /tmp/test_text.txt -e text -o /tmp/test_text_output.html
ls -la /tmp/test_text_output.html
rm /tmp/test_text.txt /tmp/test_text_output.html
  </verify>
  <done>TextExtractor has 3 pre-compiled patterns, GenericExtractor compiles in __init__, CLI works with both extractors</done>
</task>

</tasks>

<verification>
```bash
cd /Users/guthdx/terminal_projects/cosmograph
source .venv/bin/activate

# Type checking on all modified files
mypy src/cosmograph/extractors/legal.py src/cosmograph/extractors/text.py src/cosmograph/extractors/generic.py

# Linting
ruff check src/cosmograph/extractors/

# Full CLI smoke test
echo "ARTICLE I - TEST
SECTION 1. Test content.
# Markdown Header
\"Test Term\" means something defined." > /tmp/combined_test.txt

cosmograph generate /tmp/combined_test.txt -e legal -o /tmp/legal_out.html
cosmograph generate /tmp/combined_test.txt -e text -o /tmp/text_out.html
cosmograph generate /tmp/combined_test.txt -e generic -o /tmp/generic_out.html

ls -la /tmp/*_out.html
rm /tmp/combined_test.txt /tmp/*_out.html
```
</verification>

<success_criteria>
- All extractors have pre-compiled regex patterns (class or instance level)
- No raw string patterns passed to re.finditer()
- mypy passes on all extractor files
- ruff check passes
- All three extractors (legal, text, generic) produce valid HTML output
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cleanup/01-03-SUMMARY.md`
</output>
