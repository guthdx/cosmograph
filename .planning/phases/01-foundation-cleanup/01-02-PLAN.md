---
phase: 01-foundation-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cosmograph/models.py
autonomous: true

must_haves:
  truths:
    - "re module imported at top of file, not inside method"
    - "Edge deduplication uses O(1) set lookup, not O(n) list scan"
    - "Existing CLI functionality unchanged"
  artifacts:
    - path: "src/cosmograph/models.py"
      provides: "Graph, Node, Edge dataclasses with optimized edge dedup"
      contains: "_edge_keys: set"
  key_links:
    - from: "src/cosmograph/models.py"
      to: "re module"
      via: "top-level import"
      pattern: "^import re"
---

<objective>
Fix models.py technical debt: move re import to top of file and add O(1) edge deduplication.

Purpose: Current _clean_id() imports re inside method (import per call). Current add_edge() scans entire edge list for duplicates (O(n)). Both are performance issues that compound with graph size.

Output: Updated models.py with proper import location and set-based edge deduplication
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/01-foundation-cleanup/01-RESEARCH.md

# File to modify
@src/cosmograph/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix re import and add edge deduplication set</name>
  <files>src/cosmograph/models.py</files>
  <action>
1. Move `import re` from inside `_clean_id()` method to top of file (after dataclasses import)

2. Add `_edge_keys` field to Graph dataclass:
```python
_edge_keys: set[tuple[str, str, str]] = field(default_factory=set, repr=False)
```
The `repr=False` keeps it out of Graph string representation.

3. Update `add_edge()` method to use set-based deduplication:
```python
def add_edge(self, source: str, target: str, edge_type: str) -> bool:
    """Add an edge if both nodes exist and edge is unique."""
    source_id = self._clean_id(source)
    target_id = self._clean_id(target)

    # Skip self-loops
    if source_id == target_id:
        return False

    # O(1) duplicate check using set
    edge_key = (source_id, target_id, edge_type)
    if edge_key in self._edge_keys:
        return False

    self._edge_keys.add(edge_key)
    self.edges.append(Edge(source_id, target_id, edge_type))
    return True
```

Keep all existing method signatures and return types unchanged. The external API remains identical.
  </action>
  <verify>
# Verify import at top of file
head -10 /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/models.py | grep "^import re"

# Verify _edge_keys field exists
grep "_edge_keys" /Users/guthdx/terminal_projects/cosmograph/src/cosmograph/models.py

# Verify CLI still works
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate && cosmograph --help
  </verify>
  <done>re imported at file top, _edge_keys set added, add_edge uses O(1) lookup, CLI help works</done>
</task>

<task type="auto">
  <name>Task 2: Verify existing functionality preserved</name>
  <files>None (verification only)</files>
  <action>
Run quick smoke test to ensure changes didn't break anything:

1. Create a small test document
2. Run cosmograph generate on it
3. Verify HTML output is created

This ensures the models still work correctly with extractors and generators.
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate

# Create temp test file
echo "ARTICLE I - TEST
SECTION 1. Test section content.
TITLE I: TEST CODE
CHAPTER 1: GENERAL PROVISIONS" > /tmp/test_legal.txt

# Run extraction
cosmograph generate /tmp/test_legal.txt -e legal -o /tmp/test_output.html

# Verify output exists and has content
ls -la /tmp/test_output.html
wc -l /tmp/test_output.html

# Cleanup
rm /tmp/test_legal.txt /tmp/test_output.html
  </verify>
  <done>CLI generates HTML output successfully with modified models.py</done>
</task>

</tasks>

<verification>
```bash
cd /Users/guthdx/terminal_projects/cosmograph
source .venv/bin/activate

# Type checking
mypy src/cosmograph/models.py

# Linting
ruff check src/cosmograph/models.py

# If tests from 01-01 exist, run them
pytest tests/test_models.py -v 2>/dev/null || echo "Tests not yet created (expected if 01-01 runs in parallel)"
```
</verification>

<success_criteria>
- `import re` appears at top of models.py (not inside _clean_id)
- Graph dataclass has _edge_keys field of type set[tuple[str, str, str]]
- add_edge() uses set lookup instead of list iteration
- mypy passes with no errors
- ruff check passes
- CLI cosmograph generate still produces valid output
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cleanup/01-02-SUMMARY.md`
</output>
