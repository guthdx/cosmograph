---
phase: 01-foundation-cleanup
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - pyproject.toml
  - tests/test_extractors.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "pydantic removed from core dependencies"
    - "pymupdf moved to optional [pdf] group"
    - "pip install cosmograph works without pydantic or pymupdf"
    - "Extractor tests exist and pass"
    - "CLI smoke test exists and passes"
  artifacts:
    - path: "pyproject.toml"
      provides: "Clean dependency list"
      contains: "[project.optional-dependencies]"
    - path: "tests/test_extractors.py"
      provides: "Extractor unit tests"
      min_lines: 50
    - path: "tests/test_cli.py"
      provides: "CLI smoke tests"
      contains: "CliRunner"
  key_links:
    - from: "tests/test_cli.py"
      to: "src/cosmograph/cli.py"
      via: "typer.testing.CliRunner"
      pattern: "from typer.testing import CliRunner"
---

<objective>
Clean up unused dependencies and add tests for extractors and CLI.

Purpose: pydantic is declared but unused (models use dataclasses). pymupdf is declared but PDF extractor doesn't exist yet. Removing unused deps reduces install size and avoids confusion. Additional tests ensure extractors work correctly.

Output: Updated pyproject.toml, tests/test_extractors.py, tests/test_cli.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.2.0/ROADMAP.md
@.planning/phases/01-foundation-cleanup/01-RESEARCH.md

# Files to reference
@pyproject.toml
@src/cosmograph/cli.py
@src/cosmograph/extractors/legal.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up pyproject.toml dependencies</name>
  <files>pyproject.toml</files>
  <action>
1. Remove pydantic from core dependencies (it's not used anywhere in the codebase)

2. Move pymupdf to optional dependency group for future PDF support:
```toml
[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "ruff>=0.1.0",
    "mypy>=1.0.0",
]
pdf = [
    "pymupdf>=1.23.0",
]
llm = [
    "anthropic>=0.18.0",
    "openai>=1.0.0",
]
```

3. Core dependencies should only be:
```toml
dependencies = [
    "typer>=0.9.0",
    "rich>=13.0.0",
    "jinja2>=3.1.0",
]
```

This makes the base install lighter. PDF support added with `pip install cosmograph[pdf]`.
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate

# Verify pydantic not in dependencies
grep -c "pydantic" pyproject.toml  # Should be 0

# Verify pymupdf in optional group
grep -A 3 "\[project.optional-dependencies\]" pyproject.toml | grep -c "pdf"  # Should show pdf group

# Reinstall to verify it works
pip install -e .

# Verify CLI still works
cosmograph --help
  </verify>
  <done>pydantic removed, pymupdf in [pdf] optional group, pip install works, CLI works</done>
</task>

<task type="auto">
  <name>Task 2: Add extractor tests</name>
  <files>tests/test_extractors.py</files>
  <action>
Create tests/test_extractors.py with tests for each extractor:

```python
import pytest
from pathlib import Path
from cosmograph.extractors import LegalDocumentExtractor, TextExtractor, GenericExtractor
from cosmograph.models import Graph


class TestLegalDocumentExtractor:
    """Tests for LegalDocumentExtractor."""

    @pytest.fixture
    def extractor(self):
        return LegalDocumentExtractor()

    def test_supports_txt_files(self, extractor):
        assert extractor.supports(Path("test.txt"))
        assert extractor.supports(Path("test.md"))
        assert not extractor.supports(Path("test.pdf"))

    def test_extracts_articles(self, extractor, tmp_path):
        test_file = tmp_path / "constitution.txt"
        test_file.write_text("ARTICLE I - RIGHTS\nSome content here.")
        graph = extractor.extract(test_file)
        # Should have document node + article node
        assert len(graph.nodes) >= 2
        assert any("Article I" in n.label for n in graph.nodes.values())

    def test_extracts_sections(self, extractor, tmp_path):
        test_file = tmp_path / "constitution.txt"
        test_file.write_text("SECTION 1. Test section content.")
        graph = extractor.extract(test_file)
        assert any("Section 1" in n.label for n in graph.nodes.values())

    def test_detects_constitution_type(self, extractor, tmp_path):
        test_file = tmp_path / "tribal_constitution.txt"
        test_file.write_text("CONSTITUTION OF THE TRIBE")
        graph = extractor.extract(test_file)
        doc_node = list(graph.nodes.values())[0]
        assert doc_node.category == "constitution"


class TestTextExtractor:
    """Tests for TextExtractor."""

    @pytest.fixture
    def extractor(self):
        return TextExtractor()

    def test_supports_text_files(self, extractor):
        assert extractor.supports(Path("readme.md"))
        assert extractor.supports(Path("doc.txt"))

    def test_extracts_markdown_headers(self, extractor, tmp_path):
        test_file = tmp_path / "readme.md"
        test_file.write_text("# Main Title\n## Subtitle\nContent here.")
        graph = extractor.extract(test_file)
        assert any("Main Title" in n.label for n in graph.nodes.values())
        assert any("Subtitle" in n.label for n in graph.nodes.values())


class TestGenericExtractor:
    """Tests for GenericExtractor."""

    @pytest.fixture
    def extractor(self):
        return GenericExtractor(min_occurrences=1)  # Lower threshold for testing

    def test_extracts_proper_nouns(self, extractor, tmp_path):
        test_file = tmp_path / "doc.txt"
        test_file.write_text("John Smith went to New York. John Smith returned.")
        graph = extractor.extract(test_file)
        assert any("John Smith" in n.label for n in graph.nodes.values())

    def test_respects_min_occurrences(self, tmp_path):
        extractor = GenericExtractor(min_occurrences=3)
        test_file = tmp_path / "doc.txt"
        test_file.write_text("Rare Name appears once. Common Name appears. Common Name appears. Common Name appears.")
        graph = extractor.extract(test_file)
        assert any("Common Name" in n.label for n in graph.nodes.values())
        # Rare Name should not appear (only 1 occurrence)
```
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate
pytest tests/test_extractors.py -v
  </verify>
  <done>All extractor tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI smoke tests</name>
  <files>tests/test_cli.py</files>
  <action>
Create tests/test_cli.py with CLI integration tests using CliRunner:

```python
import pytest
from typer.testing import CliRunner
from pathlib import Path
from cosmograph.cli import app

runner = CliRunner()


class TestCLI:
    """CLI smoke tests."""

    def test_help_command(self):
        result = runner.invoke(app, ["--help"])
        assert result.exit_code == 0
        assert "cosmograph" in result.stdout.lower() or "generate" in result.stdout.lower()

    def test_generate_help(self):
        result = runner.invoke(app, ["generate", "--help"])
        assert result.exit_code == 0
        assert "extractor" in result.stdout.lower() or "-e" in result.stdout

    def test_generate_legal_document(self, tmp_path):
        # Create test input
        input_file = tmp_path / "test.txt"
        input_file.write_text("ARTICLE I - TEST\nSECTION 1. Content.")
        output_file = tmp_path / "output.html"

        result = runner.invoke(app, [
            "generate",
            str(input_file),
            "-e", "legal",
            "-o", str(output_file)
        ])

        assert result.exit_code == 0
        assert output_file.exists()
        assert output_file.stat().st_size > 0

    def test_generate_text_document(self, tmp_path):
        input_file = tmp_path / "test.md"
        input_file.write_text("# Header\nSome content.")
        output_file = tmp_path / "output.html"

        result = runner.invoke(app, [
            "generate",
            str(input_file),
            "-e", "text",
            "-o", str(output_file)
        ])

        assert result.exit_code == 0
        assert output_file.exists()

    def test_generate_with_title(self, tmp_path):
        input_file = tmp_path / "test.txt"
        input_file.write_text("Test content")
        output_file = tmp_path / "output.html"

        result = runner.invoke(app, [
            "generate",
            str(input_file),
            "-t", "My Custom Title",
            "-o", str(output_file)
        ])

        assert result.exit_code == 0
        html = output_file.read_text()
        assert "My Custom Title" in html

    def test_nonexistent_file_error(self, tmp_path):
        result = runner.invoke(app, [
            "generate",
            str(tmp_path / "nonexistent.txt")
        ])
        # Should fail gracefully
        assert result.exit_code != 0 or "error" in result.stdout.lower() or "not found" in result.stdout.lower()
```
  </action>
  <verify>
cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate
pytest tests/test_cli.py -v
  </verify>
  <done>All CLI tests pass</done>
</task>

</tasks>

<verification>
```bash
cd /Users/guthdx/terminal_projects/cosmograph
source .venv/bin/activate

# Run all tests
pytest tests/ -v

# Run with coverage
pytest tests/ --cov=src/cosmograph --cov-report=term-missing

# Verify clean install (optional - in new venv)
# python -m venv /tmp/test_venv
# source /tmp/test_venv/bin/activate
# pip install /Users/guthdx/terminal_projects/cosmograph
# cosmograph --help
# deactivate
# rm -rf /tmp/test_venv
```
</verification>

<success_criteria>
- pyproject.toml has no pydantic in dependencies
- pymupdf is in optional [pdf] group
- pip install cosmograph (without extras) works
- tests/test_extractors.py has tests for all 3 extractors
- tests/test_cli.py has smoke tests for CLI commands
- All tests pass
- CLI works after dependency cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cleanup/01-05-SUMMARY.md`
</output>
