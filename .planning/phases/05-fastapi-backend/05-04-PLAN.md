---
phase: 05-fastapi-backend
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/cosmograph/api/routes/graph.py
  - src/cosmograph/api/routes/extract.py
  - src/cosmograph/api/main.py
autonomous: true

must_haves:
  truths:
    - "Can get graph JSON via GET /api/graph/{id}"
    - "Can download HTML visualization via GET /api/download/{id}"
    - "Can stream progress updates via SSE"
  artifacts:
    - path: "src/cosmograph/api/routes/graph.py"
      provides: "Graph retrieval and download endpoints"
      min_lines: 50
      contains: "@router.get"
    - path: "src/cosmograph/api/routes/extract.py"
      provides: "SSE progress endpoint"
      contains: "EventSourceResponse"
  key_links:
    - from: "src/cosmograph/api/routes/graph.py"
      to: "src/cosmograph/api/deps.py"
      via: "reads job result"
      pattern: "job_store"
    - from: "src/cosmograph/api/routes/extract.py"
      to: "sse_starlette"
      via: "uses SSE"
      pattern: "EventSourceResponse"
---

<objective>
Implement graph retrieval, download, and SSE progress endpoints

Purpose: Complete the API by adding endpoints to retrieve processed graphs as JSON, download the generated HTML visualization, and stream real-time progress updates via Server-Sent Events.

Output:
- GET /api/graph/{job_id} - retrieve graph JSON
- GET /api/download/{job_id} - download HTML file
- GET /api/extract/{job_id}/progress - SSE progress stream
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fastapi-backend/05-RESEARCH.md
@.planning/phases/05-fastapi-backend/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create graph routes module</name>
  <files>src/cosmograph/api/routes/graph.py</files>
  <action>
Create `routes/graph.py` with graph retrieval and download endpoints:

1. Imports:
   - Path from pathlib
   - APIRouter, HTTPException from fastapi
   - FileResponse from fastapi.responses
   - job_store, Job from deps
   - GraphResponse from schemas
   - JobNotFoundError from exceptions

2. Create router with prefix="/api"

3. GET /graph/{job_id} endpoint:
   ```python
   @router.get("/graph/{job_id}", response_model=GraphResponse)
   async def get_graph(job_id: str):
   ```
   - Get job from store, raise 404 if not found
   - If status != completed, raise 400 "Extraction not complete"
   - Return job.result (which is the graph JSON)

4. GET /download/{job_id} endpoint:
   ```python
   @router.get("/download/{job_id}")
   async def download_html(job_id: str):
   ```
   - Get job from store, raise 404 if not found
   - If status != completed, raise 400 "Extraction not complete"
   - Get HTML path from job.output_dir / "index.html"
   - If file not found, raise 404 "Output file not found"
   - Return FileResponse with:
     - media_type="text/html"
     - filename=f"{job_id}_graph.html"

5. GET /download/{job_id}/csv endpoint (optional but useful):
   ```python
   @router.get("/download/{job_id}/csv")
   async def download_csv(job_id: str):
   ```
   - Similar to HTML but returns ZIP of nodes/edges CSVs
   - Use shutil.make_archive to create zip in temp location
   - Return FileResponse with media_type="application/zip"
  </action>
  <verify>
Run: `python -c "from cosmograph.api.routes.graph import router; print(f'{len(router.routes)} routes')"`
Run: `mypy src/cosmograph/api/routes/graph.py`
  </verify>
  <done>Graph routes provide JSON retrieval and file downloads</done>
</task>

<task type="auto">
  <name>Task 2: Add SSE progress endpoint</name>
  <files>src/cosmograph/api/routes/extract.py</files>
  <action>
Add SSE progress streaming to extract.py:

1. Add imports:
   - asyncio
   - json
   - EventSourceResponse from sse_starlette.sse

2. Add GET /extract/{job_id}/progress endpoint:
   ```python
   @router.get("/extract/{job_id}/progress")
   async def extraction_progress(job_id: str):
       async def event_generator():
           while True:
               job = job_store.get_job(job_id)
               if not job:
                   yield {"event": "error", "data": json.dumps({"error": "Job not found"})}
                   break

               yield {
                   "event": "progress",
                   "data": json.dumps({
                       "status": job.status.value,
                       "progress": job.progress,
                       "total": job.total,
                   })
               }

               if job.status in (JobStatus.COMPLETED, JobStatus.FAILED):
                   # Send final event with result or error
                   if job.status == JobStatus.COMPLETED:
                       yield {"event": "complete", "data": json.dumps({"job_id": job_id})}
                   else:
                       yield {"event": "error", "data": json.dumps({"error": job.error})}
                   break

               await asyncio.sleep(0.5)  # Poll every 500ms

       return EventSourceResponse(event_generator())
   ```

Key design:
- SSE is unidirectional server->client, simpler than WebSocket
- Client connects, receives progress events until completion
- Frontend can use EventSource API to listen
- 500ms polling interval balances responsiveness vs overhead
  </action>
  <verify>
Start server, then test SSE:
`curl -N http://localhost:8000/api/extract/{job_id}/progress`
Should see event stream with progress updates.
  </verify>
  <done>SSE endpoint streams progress updates in real-time</done>
</task>

<task type="auto">
  <name>Task 3: Register graph router and update job store for output tracking</name>
  <files>src/cosmograph/api/main.py, src/cosmograph/api/deps.py, src/cosmograph/api/routes/extract.py</files>
  <action>
1. Update deps.py Job dataclass:
   - Ensure output_dir: Path | None = None field exists for tracking temp directory
   - Add method to Job or JobStore to set output_dir when extraction completes

2. Update extract.py run_extraction():
   - Store output_dir in job when calling complete_job
   - Modify job_store.complete_job() to accept output_dir parameter

3. Update main.py:
   - Import: from .routes import graph
   - Add: app.include_router(graph.router)

4. Test full flow:
   - Upload file, get job_id
   - Poll progress SSE endpoint
   - Wait for completion
   - Get graph JSON
   - Download HTML
  </action>
  <verify>
Full curl test:
1. `curl -X POST .../api/extract -F "files=@test.txt"` -> job_id
2. `curl .../api/extract/{job_id}/progress` -> see events
3. `curl .../api/graph/{job_id}` -> JSON
4. `curl .../api/download/{job_id}` -> HTML file
  </verify>
  <done>All graph routes registered and working end-to-end</done>
</task>

</tasks>

<verification>
- `curl /api/graph/{job_id}` returns graph JSON after completion
- `curl /api/download/{job_id}` downloads HTML file
- `curl -N /api/extract/{job_id}/progress` streams SSE events
- Jobs track output_dir for file serving
- `mypy src/cosmograph/api/` clean
</verification>

<success_criteria>
- Graph JSON retrievable after extraction
- HTML visualization downloadable
- SSE progress updates work in real-time
- All endpoints handle error cases properly
- Full flow works: upload -> poll -> get result
</success_criteria>

<output>
After completion, create `.planning/phases/05-fastapi-backend/05-04-SUMMARY.md`
</output>
