---
phase: 05-fastapi-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/cosmograph/services/__init__.py
  - src/cosmograph/services/extraction.py
autonomous: true

must_haves:
  truths:
    - "Service layer exists independent of CLI/API framework"
    - "ExtractionService can process files and return Graph"
    - "ExtractionService supports progress callbacks"
    - "FastAPI dependencies are installed"
  artifacts:
    - path: "src/cosmograph/services/__init__.py"
      provides: "Service module exports"
      exports: ["ExtractionService"]
    - path: "src/cosmograph/services/extraction.py"
      provides: "Framework-agnostic extraction orchestration"
      min_lines: 60
      contains: "class ExtractionService"
    - path: "pyproject.toml"
      provides: "API dependencies in [api] group"
      contains: "fastapi"
  key_links:
    - from: "src/cosmograph/services/extraction.py"
      to: "src/cosmograph/extractors/__init__.py"
      via: "imports extractors"
      pattern: "from.*extractors import"
    - from: "src/cosmograph/services/extraction.py"
      to: "src/cosmograph/generators/__init__.py"
      via: "imports generators"
      pattern: "from.*generators import"
---

<objective>
Create service layer and add API dependencies

Purpose: Extract business logic from cli.py into framework-agnostic service classes that both CLI and API can use. This follows the service layer architecture pattern where business logic is decoupled from HTTP/CLI concerns.

Output:
- ExtractionService class in services module
- FastAPI + supporting deps in pyproject.toml [api] optional group
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fastapi-backend/05-RESEARCH.md

# Current codebase
@src/cosmograph/cli.py
@src/cosmograph/extractors/__init__.py
@src/cosmograph/generators/__init__.py
@src/cosmograph/models.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI dependencies to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add new [api] optional dependency group with:
- fastapi>=0.115.0 (Iyeska standard)
- uvicorn[standard]>=0.30.0 (ASGI server with websocket support)
- python-multipart>=0.0.9 (required for UploadFile form data parsing)
- sse-starlette>=2.0.0 (Server-Sent Events for progress streaming)
- httpx>=0.27.0 (async HTTP client for testing)

Keep existing groups (dev, pdf, llm) unchanged.

Add an [all] convenience group that combines dev + pdf + llm + api for full development setup.
  </action>
  <verify>
Run: `source .venv/bin/activate && pip install -e ".[api]"`
Verify FastAPI installed: `python -c "import fastapi; print(fastapi.__version__)"`
  </verify>
  <done>FastAPI and supporting packages installable via pip install -e ".[api]"</done>
</task>

<task type="auto">
  <name>Task 2: Create ExtractionService class</name>
  <files>src/cosmograph/services/__init__.py, src/cosmograph/services/extraction.py</files>
  <action>
Create `src/cosmograph/services/` directory with:

1. `__init__.py`:
   - Export ExtractionService
   - Simple __all__ list

2. `extraction.py`:
   - Import from ..extractors, ..generators, ..models, ..config
   - Create ExtractionService class with:
     - __init__(self, output_dir: Path | None = None) - optional output dir
     - get_extractor(extractor_type: str, graph: Graph, config: PatternConfig | None = None, interactive: bool = True) -> BaseExtractor - factory method matching cli.py logic
     - process_files(files: list[Path], extractor_type: str, title: str, pattern_config: PatternConfig | None = None, progress_callback: Callable[[int, int], None] | None = None, interactive: bool = True) -> Graph - main processing method
     - generate_outputs(graph: Graph, output_dir: Path, title: str, html_only: bool = False) -> dict[str, Path] - generates HTML/CSV, returns paths

Key design points:
- Service is framework-agnostic (no typer, no fastapi imports)
- progress_callback(current: int, total: int) called after each file
- Raises domain exceptions, not HTTP exceptions
- Use typing for all parameters and return types
- Handle HAS_ANTHROPIC check for LLM extractor (raise ValueError if not available)
- Handle OperatorDeclinedError - let it propagate, caller handles

Reference cli.py _get_extractor() and generate() command for logic to extract.
  </action>
  <verify>
Run: `python -c "from cosmograph.services import ExtractionService; print('Service imported')"`
Run: `mypy src/cosmograph/services/`
  </verify>
  <done>ExtractionService class importable and type-checks clean</done>
</task>

<task type="auto">
  <name>Task 3: Add basic service unit tests</name>
  <files>tests/test_services.py</files>
  <action>
Create tests/test_services.py with tests for ExtractionService:

1. test_extraction_service_init() - can instantiate with/without output_dir
2. test_get_extractor_legal() - returns LegalDocumentExtractor
3. test_get_extractor_text() - returns TextExtractor
4. test_get_extractor_generic() - returns GenericExtractor
5. test_get_extractor_auto() - returns default extractor (LegalDocumentExtractor)
6. test_get_extractor_llm_without_package() - raises ValueError when HAS_ANTHROPIC is False (mock it)
7. test_process_files_with_progress() - verify progress_callback called correctly
8. test_generate_outputs() - verify output files created

Use pytest fixtures for temp directories.
Import from cosmograph.services, cosmograph.extractors, cosmograph.models.
Mock extractors where needed to avoid heavy processing.
  </action>
  <verify>
Run: `pytest tests/test_services.py -v`
All tests pass.
  </verify>
  <done>Service tests pass, coverage on service module</done>
</task>

</tasks>

<verification>
- `pip install -e ".[api]"` succeeds
- `python -c "from cosmograph.services import ExtractionService"` works
- `pytest tests/test_services.py -v` passes
- `mypy src/cosmograph/services/` clean
- `ruff check src/cosmograph/services/` clean
</verification>

<success_criteria>
- ExtractionService exists and is importable
- Service is framework-agnostic (no HTTP concerns)
- FastAPI deps installable via [api] group
- Service tests pass
- CLI still works (unchanged for now)
</success_criteria>

<output>
After completion, create `.planning/phases/05-fastapi-backend/05-01-SUMMARY.md`
</output>
