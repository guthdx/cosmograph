---
phase: 05-fastapi-backend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cosmograph/api/__init__.py
  - src/cosmograph/api/main.py
  - src/cosmograph/api/schemas.py
  - src/cosmograph/api/deps.py
  - src/cosmograph/api/exceptions.py
  - src/cosmograph/api/routes/__init__.py
  - src/cosmograph/api/routes/health.py
autonomous: true

must_haves:
  truths:
    - "FastAPI app starts with uvicorn"
    - "Health endpoint returns {status: healthy}"
    - "CORS configured for localhost development"
    - "API has OpenAPI docs at /docs"
  artifacts:
    - path: "src/cosmograph/api/main.py"
      provides: "FastAPI application"
      min_lines: 40
      contains: "FastAPI"
    - path: "src/cosmograph/api/schemas.py"
      provides: "Pydantic request/response models"
      contains: "class JobStatus"
    - path: "src/cosmograph/api/deps.py"
      provides: "Job store and dependencies"
      contains: "class JobStore"
    - path: "src/cosmograph/api/routes/health.py"
      provides: "Health check endpoint"
      contains: "@router.get"
  key_links:
    - from: "src/cosmograph/api/main.py"
      to: "src/cosmograph/api/routes/health.py"
      via: "router include"
      pattern: "include_router"
---

<objective>
Create FastAPI app skeleton with health endpoint

Purpose: Set up the FastAPI application structure with proper project organization, CORS for local development, and a health endpoint to verify the API is running. This establishes the foundation for extraction routes.

Output:
- FastAPI app in api module with lifespan management
- Job store for tracking extraction progress
- Health endpoint at GET /health
- Pydantic schemas for API contracts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fastapi-backend/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API module structure and schemas</name>
  <files>src/cosmograph/api/__init__.py, src/cosmograph/api/schemas.py, src/cosmograph/api/exceptions.py</files>
  <action>
Create `src/cosmograph/api/` directory structure:

1. `__init__.py`:
   - Empty or minimal docstring

2. `schemas.py` - Pydantic models for API contracts:
   - JobStatus(str, Enum): pending, processing, completed, failed
   - ExtractionRequest(BaseModel): extractor (str, default="auto"), title (str, default="Knowledge Graph"), llm_confirmed (bool, default=False) - for LLM approval
   - JobResponse(BaseModel): job_id (str), status (JobStatus), progress (int), total (int), created_at (datetime), error (str | None)
   - GraphResponse(BaseModel): title (str), nodes (list[dict]), edges (list[dict]), stats (dict)
   - ErrorResponse(BaseModel): detail (str), error_code (str | None)
   - Use model_config with json_schema_extra for examples (Pydantic v2 style)

3. `exceptions.py` - Domain exceptions:
   - ExtractionError(Exception): message, filename
   - JobNotFoundError(Exception): job_id
   - extraction_error_handler(request, exc) -> JSONResponse with 422 status
   - job_not_found_handler(request, exc) -> JSONResponse with 404 status
  </action>
  <verify>
Run: `python -c "from cosmograph.api.schemas import JobStatus, ExtractionRequest, JobResponse; print('Schemas OK')"`
Run: `mypy src/cosmograph/api/schemas.py src/cosmograph/api/exceptions.py`
  </verify>
  <done>API schemas and exceptions importable and type-check clean</done>
</task>

<task type="auto">
  <name>Task 2: Create job store and dependencies</name>
  <files>src/cosmograph/api/deps.py</files>
  <action>
Create `deps.py` with job management:

1. Job dataclass:
   - id: str
   - status: JobStatus
   - created_at: datetime
   - progress: int = 0
   - total: int = 0
   - result: dict | None = None (graph JSON when complete)
   - error: str | None = None
   - output_dir: Path | None = None (for cleanup)

2. JobStore class (in-memory, single-process):
   - __init__(): self._jobs: dict[str, Job] = {}
   - create_job(total: int = 0) -> Job: generates 8-char UUID, creates Job
   - get_job(job_id: str) -> Job | None
   - update_progress(job_id: str, progress: int): sets progress and status=processing
   - complete_job(job_id: str, result: dict): sets status=completed, stores result
   - fail_job(job_id: str, error: str): sets status=failed, stores error

3. Global job_store instance (module-level singleton)

4. get_job_store() dependency function for FastAPI injection

Note: Per REQUIREMENTS.md, no persistence needed - "Results exist only during session"
  </action>
  <verify>
Run: `python -c "from cosmograph.api.deps import JobStore, get_job_store; js = JobStore(); job = js.create_job(5); print(f'Job {job.id} created')"`
  </verify>
  <done>JobStore functional with create/get/update/complete/fail operations</done>
</task>

<task type="auto">
  <name>Task 3: Create FastAPI app and health route</name>
  <files>src/cosmograph/api/main.py, src/cosmograph/api/routes/__init__.py, src/cosmograph/api/routes/health.py</files>
  <action>
1. `routes/__init__.py`: empty or minimal docstring

2. `routes/health.py`:
   - APIRouter with no prefix (health is at root)
   - GET /health -> {"status": "healthy"}
   - Add version info: include cosmograph version from package

3. `main.py`:
   - Import asynccontextmanager from contextlib
   - Create lifespan context manager (startup: log "Starting Cosmograph API", shutdown: log "Shutting down")
   - Create FastAPI app with:
     - title="Cosmograph API"
     - version=__version__ (from cosmograph package)
     - lifespan=lifespan
   - Add CORSMiddleware with:
     - allow_origins: ["http://localhost:3000", "http://localhost:5173", "http://cosmograph.localhost"]
     - allow_credentials=True
     - allow_methods=["*"]
     - allow_headers=["*"]
   - Register exception handlers from exceptions.py
   - Include health router
   - Add root route "/" that redirects to /docs (convenience)

Entry point for uvicorn: cosmograph.api.main:app
  </action>
  <verify>
Run: `cd /Users/guthdx/terminal_projects/cosmograph && source .venv/bin/activate && pip install -e ".[api]" && uvicorn cosmograph.api.main:app --host 0.0.0.0 --port 8000 &`
Wait 2 seconds, then: `curl http://localhost:8000/health`
Expected: {"status":"healthy","version":"..."}
Kill uvicorn after test.
  </verify>
  <done>FastAPI app starts, health endpoint returns healthy status</done>
</task>

</tasks>

<verification>
- `uvicorn cosmograph.api.main:app` starts without errors
- `curl http://localhost:8000/health` returns {"status": "healthy", ...}
- `curl http://localhost:8000/docs` shows OpenAPI documentation
- `mypy src/cosmograph/api/` clean
- `ruff check src/cosmograph/api/` clean
</verification>

<success_criteria>
- FastAPI app starts with uvicorn
- Health endpoint accessible at /health
- OpenAPI docs at /docs
- CORS configured for development
- Job store ready for use by extraction routes
</success_criteria>

<output>
After completion, create `.planning/phases/05-fastapi-backend/05-02-SUMMARY.md`
</output>
