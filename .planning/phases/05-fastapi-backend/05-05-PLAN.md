---
phase: 05-fastapi-backend
plan: 05
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - tests/test_api.py
  - src/cosmograph/cli.py
autonomous: true

must_haves:
  truths:
    - "API has comprehensive test coverage"
    - "CLI still works exactly as before"
    - "CLI uses ExtractionService internally"
    - "All API endpoints tested"
  artifacts:
    - path: "tests/test_api.py"
      provides: "API endpoint tests"
      min_lines: 100
      contains: "TestClient"
    - path: "src/cosmograph/cli.py"
      provides: "CLI refactored to use service layer"
      contains: "ExtractionService"
  key_links:
    - from: "tests/test_api.py"
      to: "src/cosmograph/api/main.py"
      via: "TestClient"
      pattern: "from cosmograph.api.main import app"
    - from: "src/cosmograph/cli.py"
      to: "src/cosmograph/services/extraction.py"
      via: "uses service"
      pattern: "from.*services import"
---

<objective>
Add API tests and refactor CLI to use service layer

Purpose: Ensure API is well-tested with FastAPI TestClient, then refactor CLI to use ExtractionService instead of duplicating logic. This completes the service layer architecture where both CLI and API share the same business logic.

Output:
- Comprehensive API tests in tests/test_api.py
- CLI refactored to use ExtractionService
- Both interfaces share extraction logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fastapi-backend/05-RESEARCH.md
@.planning/phases/05-fastapi-backend/05-04-SUMMARY.md
@src/cosmograph/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive API tests</name>
  <files>tests/test_api.py</files>
  <action>
Create tests/test_api.py with TestClient tests:

1. Setup:
   - Import TestClient from fastapi.testclient
   - Import app from cosmograph.api.main
   - Import io, time for test helpers
   - Create client = TestClient(app)

2. Health endpoint tests:
   - test_health_check(): GET /health returns 200 and {"status": "healthy", ...}

3. Extract endpoint tests:
   - test_extract_no_files(): POST without files returns 400/422
   - test_extract_single_file(): POST with single txt file returns 200 with job_id
   - test_extract_multiple_files(): POST with multiple files returns job
   - test_extract_llm_without_confirmation(): POST with extractor=llm and llm_confirmed=false returns 400
   - test_extract_invalid_extractor(): POST with unknown extractor returns 400
   - test_extract_job_status(): POST then GET /extract/{id} returns job status

4. Job status tests:
   - test_get_nonexistent_job(): GET /extract/invalid-id returns 404
   - test_job_completes(): POST file, poll until status=completed (with timeout)

5. Graph endpoint tests:
   - test_get_graph_before_complete(): GET /graph/{id} when pending returns 400
   - test_get_graph_after_complete(): Complete job, GET returns graph JSON
   - test_get_graph_nonexistent(): GET /graph/invalid returns 404

6. Download endpoint tests:
   - test_download_html(): Complete job, GET /download/{id} returns HTML
   - test_download_before_complete(): GET when pending returns 400

7. Helper functions:
   - create_test_file() -> returns tuple of (filename, file content, content_type)
   - wait_for_job(client, job_id, timeout=10) -> polls until complete or timeout

Use io.BytesIO for in-memory test files.
Use pytest.fixture for common setup if needed.
  </action>
  <verify>
Run: `pytest tests/test_api.py -v`
All tests pass.
Run: `pytest tests/test_api.py --cov=src/cosmograph/api --cov-report=term-missing`
Check coverage on API module.
  </verify>
  <done>API tests pass with good coverage</done>
</task>

<task type="auto">
  <name>Task 2: Refactor CLI to use ExtractionService</name>
  <files>src/cosmograph/cli.py</files>
  <action>
Refactor cli.py generate command to use ExtractionService:

1. Add import: from .services import ExtractionService

2. Simplify generate() command:
   - Keep file collection logic (input_path validation, glob)
   - Keep pattern config loading
   - Create ExtractionService instance
   - Replace inline extractor selection with service.get_extractor() or process_files()
   - Use service.process_files() with a progress_callback that updates Rich progress bar
   - Use service.generate_outputs() for output generation
   - Keep Rich console output, stats printing, browser opening

3. Remove _get_extractor() function - now lives in ExtractionService

4. Progress callback integration:
   ```python
   def update_progress(current: int, total: int):
       progress.update(task, completed=current)

   graph = service.process_files(
       files=files,
       extractor_type=extractor,
       title=title,
       pattern_config=pattern_config,
       progress_callback=update_progress,
       interactive=not no_confirm,
   )
   ```

5. Keep existing CLI behavior identical:
   - Same options and arguments
   - Same output format
   - Same error handling (OperatorDeclinedError -> exit 0)

6. Preserve stats and serve commands unchanged (they don't use extraction)
  </action>
  <verify>
Run: `cosmograph --help` - works as before
Run: `cosmograph generate ./tests/fixtures/legal.txt -e legal -t "Test" --no-open` - produces output
Run existing CLI tests: `pytest tests/test_cli.py -v`
  </verify>
  <done>CLI refactored to use service layer, all existing tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and lint</name>
  <files>-</files>
  <action>
Run complete verification:

1. Full test suite:
   `pytest tests/ -v --cov=src/cosmograph --cov-report=term-missing`

2. Type checking:
   `mypy src/cosmograph/`

3. Linting:
   `ruff check src/cosmograph/ tests/`

4. Manual API test:
   - Start server: `uvicorn cosmograph.api.main:app --reload`
   - Test endpoints with curl
   - Verify OpenAPI docs at /docs

5. Manual CLI test:
   - `cosmograph generate tests/fixtures/legal.txt -t "Test" --no-open`
   - Verify output created

Fix any issues found. Target: 80%+ coverage on new code, all tests passing.
  </action>
  <verify>
- `pytest tests/ -v` - all pass
- `mypy src/cosmograph/` - clean
- `ruff check src/` - clean
- Coverage report shows API and services covered
  </verify>
  <done>Full test suite passes, code quality checks clean</done>
</task>

</tasks>

<verification>
- `pytest tests/test_api.py -v` - all API tests pass
- `pytest tests/test_cli.py -v` - CLI tests still pass
- `pytest tests/ --cov=src/cosmograph` - good coverage
- `mypy src/cosmograph/` - no errors
- `ruff check src/` - no errors
- CLI works: `cosmograph generate file.txt -e legal`
- API works: `curl POST /api/extract` flow
</verification>

<success_criteria>
- API has comprehensive test coverage (12+ tests)
- CLI refactored to use ExtractionService
- All existing CLI tests pass (no regression)
- Type checking and linting clean
- Both CLI and API functional end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-fastapi-backend/05-05-SUMMARY.md`
</output>
