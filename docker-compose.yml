# Cosmograph Development Docker Compose
#
# Provides Traefik integration for http://cosmograph.localhost routing.
# This is OPTIONAL - native development (uvicorn + npm run dev) works fine.
#
# Usage:
#   1. Start Traefik: cd ~/terminal_projects/claude_code/traefik && docker compose up -d
#   2. Start Cosmograph: docker compose up -d
#   3. Access: http://cosmograph.localhost
#
# For native development (recommended during active development):
#   - Backend: uvicorn cosmograph.api.main:app --reload
#   - Frontend: cd frontend && npm run dev
#   - Access: http://localhost:5173 (frontend handles /api proxy to :8000)

services:
  frontend:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cosmograph.rule=Host(`cosmograph.localhost`) && !PathPrefix(`/api`)"
      - "traefik.http.services.cosmograph.loadbalancer.server.port=5173"
    networks:
      - traefik-dev
      - default

  backend:
    image: python:3.13-slim
    working_dir: /app
    command: sh -c "pip install -e '.[dev]' && uvicorn cosmograph.api.main:app --host 0.0.0.0 --reload"
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cosmograph-api.rule=Host(`cosmograph.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.services.cosmograph-api.loadbalancer.server.port=8000"
    networks:
      - traefik-dev
      - default

volumes:
  frontend_node_modules:

networks:
  traefik-dev:
    external: true
